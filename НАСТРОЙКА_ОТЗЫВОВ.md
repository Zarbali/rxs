# Настройка системы отзывов (Discord + Supabase)

Отзывы работают через авторизацию Discord и хранение в Supabase.

---

## Шаг 1: Создать приложение Discord

1. Перейдите на [discord.com/developers/applications](https://discord.com/developers/applications)
2. Нажмите **New Application**, введите имя (например: RXS Reviews)
3. В левом меню: **OAuth2** → **Redirects**
4. Добавьте redirect URL (замените `YOUR_PROJECT_REF` на ваш Project Reference из Supabase):
   ```
   https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback
   ```
   Пример: `https://abcdefgh.supabase.co/auth/v1/callback`
5. Сохраните **Client ID** и **Client Secret** (вкладка OAuth2 → General)

---

## Шаг 2: Создать проект Supabase

1. Зарегистрируйтесь на [supabase.com](https://supabase.com)
2. **New Project** — выберите организацию, имя, пароль БД
3. После создания откройте **Project Settings** (иконка шестерёнки) → **API**:
   - **Project URL** — скопируйте
   - **anon public** — скопируйте (это ваш anon key)

---

## Шаг 3: Подключить Discord в Supabase

1. В Supabase: **Authentication** → **Providers**
2. Найдите **Discord** и включите (Enabled = ON)
3. Вставьте **Client ID** и **Client Secret** из Discord
4. В **Redirect URL** укажите URL вашего сайта (для GitHub Pages: `https://username.github.io/repo-name/` или корень домена)

---

## Шаг 4: Создать таблицу отзывов

В Supabase откройте **SQL Editor** и выполните:

```sql
create table public.reviews (
  id uuid default gen_random_uuid() primary key,
  user_id uuid not null,
  user_name text,
  user_avatar text,
  text text not null check (char_length(text) >= 10),
  created_at timestamptz default now()
);

-- Только авторизованные могут писать отзывы
alter table public.reviews enable row level security;

create policy "Authenticated users can insert"
  on public.reviews for insert
  to authenticated
  with check (true);

-- Все могут читать отзывы (и гости, и авторизованные)
create policy "Anyone can read"
  on public.reviews for select
  to anon, authenticated
  using (true);
```

---

## Шаг 5: Заполнить config.js

Откройте `config.js` и замените значения:

```javascript
const SUPABASE_CONFIG = {
    url: 'https://ВАШ_PROJECT_REF.supabase.co',
    anonKey: 'ВАШ_ANON_KEY'
};
```

**Важно:** не публикуйте `service_role` key — используйте только `anon public`.

---

## Шаг 6: Redirect URL в Supabase (ОБЯЗАТЕЛЬНО!)

**Если после Discord не возвращает на сайт** — добавьте URL в Supabase:

1. **Authentication** → **URL Configuration**
2. **Site URL:** `https://zarbali.github.io/rxs/`
3. **Redirect URLs** — нажмите «Add URL» и добавьте **точно**:
   ```
   https://zarbali.github.io/rxs/reviews.html
   ```
4. Сохраните (Save)

**Discord Developer Portal** → OAuth2 → Redirects — там должен быть **только**:
```
https://hkvmbhrhzitumvtgwzyq.supabase.co/auth/v1/callback
```
(НЕ ваш сайт — Discord отправляет в Supabase, Supabase потом редиректит на ваш сайт)

---

## Проверка

1. Откройте сайт и перейдите на страницу «Отзывы» (reviews.html)
2. Нажмите «Войти через Discord» — должен открыться Discord для авторизации
3. После входа появится форма отзыва
4. Напишите отзыв (минимум 10 символов) и нажмите «Отправить»
5. Отзыв появится в списке

---

## Если отзывы не видны после входа

Политика RLS разрешала чтение только роли `anon`. После входа нужна роль `authenticated`. В Supabase **SQL Editor** выполните:

```sql
drop policy if exists "Anyone can read" on public.reviews;
create policy "Anyone can read"
  on public.reviews for select
  to anon, authenticated
  using (true);
```

---

## Если не отображается вход в аккаунт

1. **Опубликуйте изменения** — закоммитьте и запушьте в GitHub, дождитесь деплоя (1–2 мин)
2. **Очистите кэш** — откройте сайт с Ctrl+Shift+R (жёсткое обновление) или в режиме инкогнито
3. В Supabase **Redirect URLs** должен быть **точный** URL: `https://zarbali.github.io/rxs/reviews.html`
4. В Discord → OAuth2 → Redirects только: `https://hkvmbhrhzitumvtgwzyq.supabase.co/auth/v1/callback`
5. Пользователи создаются в **Authentication** → **Users**, отзывы — в таблице **reviews**
